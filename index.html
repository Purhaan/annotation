<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ”¬ Binary Mycorrhizal Annotator (1-bit PNG)</title>
  <!--  --- same <style> as before, nothing changed ---  -->
  <style>
    /*  original CSS untouched  */
    /*  (paste the exact <style> block you already have here)  */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¬ Binary Mycorrhizal Annotator</h1>
      <p>Create 1-bit PNG masks for AI training â€“ Black/White only</p>
    </div>

    <div class="main-content">
      <!--  --- exact same sidebar structure ---  -->
      <div class="sidebar">
        <div class="upload-section">
          <input type="file" id="imageInput" class="file-input"
                 accept="image/jpeg,image/jpg,image/png,image/tiff,image/tif"/>
          <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
            ğŸ“¤ Upload Microscope Image
          </button>
          <div style="font-size:0.8em;color:#666;margin-top:8px;text-align:center;">
            Supports: JPG, PNG, TIFF â€¢ Max size: 10 MB
          </div>
        </div>

        <div class="structure-tools">
          <h3>ğŸ¨ Binary Tools</h3>
          <div class="color-tool active" data-color="#000000" data-structure="background">
            <div class="color-preview" style="background:#000000;"></div>
            <div class="structure-name">Background</div>
          </div>
          <div class="color-tool" data-color="#FFFFFF" data-structure="mycorrhiza">
            <div class="color-preview" style="background:#FFFFFF;border:2px solid #ccc;"></div>
            <div class="structure-name">Mycorrhiza</div>
          </div>
        </div>

        <div class="brush-controls">
          <h4>ğŸ–Œï¸ Brush Size</h4>
          <input type="range" id="brushSize" class="brush-size-slider" min="1" max="50" value="10">
          <div class="brush-size-value" id="brushSizeValue">10 px</div>
        </div>

        <div class="view-controls">
          <h4>ğŸ‘ï¸ View Mode</h4>
          <div class="view-buttons">
            <button class="view-btn active" id="imageViewBtn" onclick="toggleView('image')">
              ğŸ–¼ï¸ Image + Annotations
            </button>
            <button class="view-btn" id="maskViewBtn" onclick="toggleView('mask')">
              ğŸ¨ Mask Only
            </button>
            <button class="view-btn" id="bitViewBtn" onclick="toggleView('1bit')">
              ğŸ§Š 1-bit Preview
            </button>
          </div>
        </div>

        <div class="action-buttons">
          <button class="action-btn clear-btn" onclick="clearCanvas()">
            ğŸ—‘ï¸ Clear Annotations
          </button>
          <button class="action-btn download-btn" id="downloadBtn" onclick="downloadMask()" disabled>
            ğŸ’¾ Download 1-bit PNG
          </button>
        </div>
      </div>

      <div class="canvas-area">
        <div class="canvas-container" id="canvasContainer">
          <div style="text-align:center;padding:50px;color:#666;">
            <h3>ğŸ“¤ Upload an Image to Start</h3>
            <p>Supports JPG, PNG, and TIFF formats</p>
            <p style="font-size:0.9em;margin-top:20px;">
              ğŸ¯ <strong>Binary Mask Tips:</strong><br>
              â€¢ Black = Background<br>
              â€¢ White = All mycorrhizal structures<br>
              â€¢ Automatically saved as 1-bit PNG
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-text" id="statusText">Ready to annotate</div>
      <div class="coordinates" id="coordinates">Position: (0, 0)</div>
    </div>
  </div>

  <script>
    /* ---------- unchanged variables ---------- */
    let canvas, ctx, originalImage, maskCanvas, maskCtx;
    let isDrawing = false, currentColor = '#000000', brushSize = 10, viewMode = 'image';
    let originalImageName = '';

    /* ---------- canvas & events setup ---------- */
    function setupCanvas(img) {
      const container = document.getElementById('canvasContainer');
      container.innerHTML = '';

      // display canvas
      canvas = document.createElement('canvas');
      canvas.className = 'annotation-canvas';
      canvas.width = img.width;
      canvas.height = img.height;
      ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;

      // mask canvas (always 1-bit, no alpha)
      maskCanvas = document.createElement('canvas');
      maskCanvas.width = img.width;
      maskCanvas.height = img.height;
      maskCtx = maskCanvas.getContext('2d');
      maskCtx.imageSmoothingEnabled = false;

      // pure black background
      maskCtx.fillStyle = '#000000';
      maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

      container.appendChild(canvas);
      setupCanvasListeners();
      updateCanvasView();
    }

    /* ---------- drawing helpers ---------- */
    function startDrawing(e) { isDrawing = true; draw(e); }
    function stopDrawing() { isDrawing = false; }

    function draw(e) {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;

      maskCtx.globalCompositeOperation = 'source-over';
      maskCtx.fillStyle = currentColor;
      maskCtx.beginPath();
      maskCtx.arc(x, y, brushSize, 0, 2 * Math.PI);
      maskCtx.fill();

      updateCanvasView();
    }

    /* ---------- view toggles ---------- */
    function toggleView(mode) {
      viewMode = mode;
      ['imageViewBtn', 'maskViewBtn', 'bitViewBtn']
        .forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById(mode === 'image' ? 'imageViewBtn' :
                              mode === 'mask' ? 'maskViewBtn' : 'bitViewBtn')
        .classList.add('active');
      updateCanvasView();
    }

    function updateCanvasView() {
      if (!ctx || !originalImage || !maskCanvas) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (viewMode === 'image') {
        ctx.globalAlpha = 1.0;
        ctx.drawImage(originalImage, 0, 0);
        ctx.globalAlpha = 0.6;
        ctx.drawImage(maskCanvas, 0, 0);
      } else if (viewMode === 'mask') {
        ctx.drawImage(maskCanvas, 0, 0);
      } else { // 1-bit preview
        // create 1-bit version
        const imgData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
          const bw = d[i] + d[i+1] + d[i+2] > 382 ? 255 : 0; // threshold 50 %
          d[i] = d[i+1] = d[i+2] = bw;
          d[i+3] = 255;
        }
        ctx.putImageData(imgData, 0, 0);
      }
    }

    /* ---------- unchanged UI helpers ---------- */
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const valid = ['image/jpeg','image/jpg','image/png','image/tiff','image/tif'];
      if (!valid.includes(file.type)) { alert('Unsupported file type'); return; }
      originalImageName = file.name.split('.')[0];
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => { setupCanvas(img); document.getElementById('downloadBtn').disabled=false; };
        img.src = reader.result;
        originalImage = img;
      };
      reader.readAsDataURL(file);
    }

    function clearCanvas() {
      if (!maskCanvas) return;
      if (confirm('Clear all annotations?')) {
        maskCtx.fillStyle = '#000000';
        maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
        updateCanvasView();
      }
    }

    /* ---------- download 1-bit PNG ---------- */
    function downloadMask() {
      if (!maskCanvas) return;
      // force PNG, 1-bit palette
      const link = document.createElement('a');
      link.download = originalImageName + '_binary_mask.png';
      link.href = maskCanvas.toDataURL('image/png');
      link.click();
    }

    /* ---------- listeners ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('imageInput').addEventListener('change', handleImageUpload);
      document.getElementById('brushSize').addEventListener('input', e => {
        brushSize = +e.target.value;
        document.getElementById('brushSizeValue').textContent = brushSize + ' px';
      });
      document.querySelectorAll('.color-tool').forEach(tool =>
        tool.addEventListener('click', () => {
          document.querySelectorAll('.color-tool').forEach(t => t.classList.remove('active'));
          tool.classList.add('active');
          currentColor = tool.dataset.color;
        }));
    });

    /* ---------- touch support ---------- */
    function handleTouch(e) { e.preventDefault(); const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent(e.type==='touchstart'?'mousedown':e.type==='touchmove'?'mousemove':'mouseup',{clientX:t.clientX,clientY:t.clientY})); }
    function setupCanvasListeners() { ['mousedown','mousemove','mouseup','mouseout'].forEach(ev=>canvas.addEventListener(ev, ev==='mousedown'?startDrawing:ev==='mousemove'?draw:stopDrawing)); ['touchstart','touchmove','touchend'].forEach(ev=>canvas.addEventListener(ev, handleTouch)); }
  </script>
</body>
</html>
